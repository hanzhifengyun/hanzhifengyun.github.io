<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Okhttp-wiki 之 HTTPS | 汉之风云</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Okhttp-wiki 之 HTTPSOkHttp attempts to balance two competing concerns:

Connectivity to as many hosts as possible. That includes advanced hosts that run the latest versions of boringssl and less out of">
<meta property="og:type" content="article">
<meta property="og:title" content="Okhttp-wiki 之 HTTPS">
<meta property="og:url" content="http://yoursite.com/2016/03/11/HTTPS/index.html">
<meta property="og:site_name" content="汉之风云">
<meta property="og:description" content="Okhttp-wiki 之 HTTPSOkHttp attempts to balance two competing concerns:

Connectivity to as many hosts as possible. That includes advanced hosts that run the latest versions of boringssl and less out of">
<meta property="og:updated_time" content="2016-07-28T09:42:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Okhttp-wiki 之 HTTPS">
<meta name="twitter:description" content="Okhttp-wiki 之 HTTPSOkHttp attempts to balance two competing concerns:

Connectivity to as many hosts as possible. That includes advanced hosts that run the latest versions of boringssl and less out of">
  
    <link rel="alternative" href="/atom.xml" title="汉之风云" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://wx.qlogo.cn/mmopen/PiajxSqBRaEJwUCWX3ebs8QIOeOcHRKZUNY11QHyq9T2ymedED33VzrMTbGP9pQllclC5XrZx4f20gVdUrGibSxA/0" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">汉之风云</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/hanzhifengyun" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/hanzhifengyun" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Okhttp/" style="font-size: 20px;">Okhttp</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/git/" style="font-size: 10px;">git</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.sunlianshuang.com">John Sun</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">活着 开心就好</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">汉之风云</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://wx.qlogo.cn/mmopen/PiajxSqBRaEJwUCWX3ebs8QIOeOcHRKZUNY11QHyq9T2ymedED33VzrMTbGP9pQllclC5XrZx4f20gVdUrGibSxA/0" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">汉之风云</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/hanzhifengyun" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/hanzhifengyun" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-HTTPS" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/11/HTTPS/" class="article-date">
  	<time datetime="2016-03-11T02:51:52.000Z" itemprop="datePublished">2016-03-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Okhttp-wiki 之 HTTPS
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Okhttp/">Okhttp</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Okhttp/">Okhttp</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Okhttp-wiki-之-HTTPS"><a href="#Okhttp-wiki-之-HTTPS" class="headerlink" title="Okhttp-wiki 之 HTTPS"></a>Okhttp-wiki 之 HTTPS</h1><p>OkHttp attempts to balance two competing concerns:</p>
<ul>
<li><strong>Connectivity</strong> to as many hosts as possible. That includes advanced hosts that run the latest versions of <a href="https://boringssl.googlesource.com/boringssl/" target="_blank" rel="external">boringssl</a> and less out of date hosts running older versions of <a href="https://www.openssl.org/" target="_blank" rel="external">OpenSSL</a>.</li>
<li><strong>Security</strong> of the connection. This includes verification of the remote webserver with certificates and the privacy of data exchanged with strong ciphers.</li>
</ul>
<p>OkHttp试图平衡下面两者之间的矛盾关系:</p>
<ul>
<li>尽可能多的主机连接.这包括运行最新版本先进的<a href="https://boringssl.googlesource.com/boringssl/" target="_blank" rel="external">boringssl</a>主机和运行旧版本过时的<a href="https://www.openssl.org/" target="_blank" rel="external">OpenSSL</a>主机.</li>
<li>连接安全.这包括远程网络服务器证书的验证和用很强的密码交换数据的隐私.</li>
</ul>
<p>When negotiating a connection to an HTTPS server, OkHttp needs to know which <a href="http://square.github.io/okhttp/3.x/okhttp/okhttp3/TlsVersion.html" target="_blank" rel="external">TLS versions</a> and <a href="http://square.github.io/okhttp/3.x/okhttp/okhttp3/CipherSuite.html" target="_blank" rel="external">cipher suites</a> to offer. A client that wants to maximize connectivity would include obsolete TLS versions and weak-by-design cipher suites. A strict client that wants to maximize security would be limited to only the latest TLS version and strongest cipher suites.</p>
<p>当判断一个连接到HTTPS服务器的连接,OkHttp需要知道是哪个TLS版本和提供的密码组合.客户端想要最大化连接将包括过时的TLS版本和很弱的密码套件.一个严谨的客户希望最大化安全将仅限于最新的TLS版本和最强的密码组合.</p>
<p>Specific security vs. connectivity decisions are implemented by <a href="http://square.github.io/okhttp/3.x/okhttp/okhttp3/ConnectionSpec.html" target="_blank" rel="external">ConnectionSpec</a>. OkHttp includes three built-in connection specs:</p>
<ul>
<li><code>MODERN_TLS</code> is a secure configuration that connects to modern HTTPS servers.</li>
<li><code>COMPATIBLE_TLS</code> is a secure configuration that connects to secure–but not current–HTTPS servers.</li>
<li><code>CLEARTEXT</code> is an insecure configuration that is used for <code>http://</code> URLs.</li>
</ul>
<p>特定的安全与决定连接是由<a href="http://square.github.io/okhttp/3.x/okhttp/okhttp3/ConnectionSpec.html" target="_blank" rel="external">ConnectionSpec</a>实现.OkHttp包含三个内置的连接标准:</p>
<ul>
<li><code>MODERN_TLS</code> 是一个安全的配置,连接到现有服务器.</li>
<li><code>COMPATIBLE_TLS</code>  是一个安全的配置,连接到安全的但不是现有服务器.</li>
<li><code>CLEARTEXT</code> 是一个不安全的配置, 用于 http:// 的URLs.</li>
</ul>
<p>By default, OkHttp will attempt a <code>MODERN_TLS</code> connection, and fall back to <code>COMPATIBLE_TLS</code> connection if the modern configuration fails.</p>
<p>默认情况下,OkHttp将尝试 <code>MODERN_TLS</code> 连接,如果现有配置失败则回退至 <code>COMPATIBLE_TLS</code> 连接.</p>
<p>The TLS versions and cipher suites in each spec can change with each release. For example, in OkHttp 2.2 we dropped support for SSL 3.0 in response to the <a href="http://googleonlinesecurity.blogspot.ca/2014/10/this-poodle-bites-exploiting-ssl-30.html" target="_blank" rel="external">POODLE</a> attack. And in OkHttp 2.3 we dropped support for <a href="http://en.wikipedia.org/wiki/RC4#Security" target="_blank" rel="external">RC4</a>. As with your desktop web browser, staying up-to-date with OkHttp is the best way to stay secure.</p>
<p>TLS版本和密码组合在每个规格下可以改变每个版本.例如,OkHttp 2.2我们为 <a href="http://googleonlinesecurity.blogspot.ca/2014/10/this-poodle-bites-exploiting-ssl-30.html" target="_blank" rel="external">POODLE</a> 攻击向下兼容支持SSL3.0;我们在OkHttp 2.3向下兼容支持 <a href="http://en.wikipedia.org/wiki/RC4#Security" target="_blank" rel="external">RC4</a>.与桌面浏览器相同,保持安全最好的办法是保持OkHttp是最新的.</p>
<p>You can build your own connection spec with a custom set of TLS versions and cipher suites. For example, this configuration is limited to three highly-regarded cipher suites. Its drawback is that it requires Android 5.0+ and a similarly current webserver.</p>
<p>你也可以建立自己的连接规范带有一套定制的TLS版本和密码套件.例如,这个配置仅限于三个主要的密码组合.它的缺点是它需要Android 5.0+和相似的现有网络服务器.</p>
<pre><code>ConnectionSpec spec = new ConnectionSpec.Builder(ConnectionSpec.MODERN_TLS)  
    .tlsVersions(TlsVersion.TLS_1_2)
    .cipherSuites(
          CipherSuite.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
          CipherSuite.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
          CipherSuite.TLS_DHE_RSA_WITH_AES_128_GCM_SHA256)
    .build();

OkHttpClient client = new OkHttpClient.Builder() 
    .connectionSpecs(Collections.singletonList(spec))
    .build();
</code></pre><h2 id="Certificate-Pinning-证书锁定"><a href="#Certificate-Pinning-证书锁定" class="headerlink" title="Certificate Pinning 证书锁定"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CertificatePinning.java" target="_blank" rel="external">Certificate Pinning 证书锁定</a></h2><p>By default, OkHttp trusts the certificate authorities of the host platform. This strategy maximizes connectivity, but it is subject to certificate authority attacks such as the <a href="http://www.computerworld.com/article/2510951/cybercrime-hacking/hackers-spied-on-300-000-iranians-using-fake-google-certificate.html" target="_blank" rel="external">2011 DigiNotar attack</a>. It also assumes your HTTPS servers’ certificates are signed by a certificate authority.</p>
<p>默认情况下,OkHttp信任主机平台的认证中心.这一策略最大化连接,但受制于<a href="http://www.computerworld.com/article/2510951/cybercrime-hacking/hackers-spied-on-300-000-iranians-using-fake-google-certificate.html" target="_blank" rel="external">2011 DigiNotar attack</a>等认证授权攻击.它还假定HTTPS服务器的证书已经被认证中心签约.</p>
<p>Use <a href="http://square.github.io/okhttp/3.x/okhttp/okhttp3/CertificatePinner.html" target="_blank" rel="external">CertificatePinner</a> to constrain which certificate authorities are trusted. Certificate pinning increases security, but limits your server team’s abilities to update their TLS certificates. <strong>Do not use certificate pinning without the blessing of your server’s TLS administrator!</strong></p>
<p>使用 <a href="http://square.github.io/okhttp/3.x/okhttp/okhttp3/CertificatePinner.html" target="_blank" rel="external">CertificatePinner</a> 约束所信任的认证中心.证书锁定将增加安全性,但受制于服务器团队的能力来更新他们的TLS证书.<strong>不要在没有通知使用你的服务器的TLS管理员的情况下使用证书锁定!</strong></p>
<pre><code>public CertificatePinning() {
  client = new OkHttpClient.Builder()
      .certificatePinner(new CertificatePinner.Builder()
          .add(&quot;publicobject.com&quot;, &quot;sha1/DmxUShsZuNiqPQsX2Oi9uv2sCnw=&quot;)
          .add(&quot;publicobject.com&quot;, &quot;sha1/SXxoaOSEzPC6BgGmxAt/EAcsajw=&quot;)
          .add(&quot;publicobject.com&quot;, &quot;sha1/blhOM3W9V/bVQhsWAcLYwPU6n24=&quot;)
          .add(&quot;publicobject.com&quot;, &quot;sha1/T5x9IXmcrQ7YuQxXnxoCmeeQ84c=&quot;)
          .build())
      .build();
}

public void run() throws Exception {
  Request request = new Request.Builder()
      .url(&quot;https://publicobject.com/robots.txt&quot;)
      .build();

  Response response = client.newCall(request).execute();
  if (!response.isSuccessful()) throw new IOException(&quot;Unexpected code &quot; + response);

  for (Certificate certificate : response.handshake().peerCertificates()) {
    System.out.println(CertificatePinner.pin(certificate));
  }
}
</code></pre><h2 id="Customizing-Trusted-Certificates-定制被信任的证书"><a href="#Customizing-Trusted-Certificates-定制被信任的证书" class="headerlink" title="Customizing Trusted Certificates 定制被信任的证书"></a><a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CustomTrust.java" target="_blank" rel="external">Customizing Trusted Certificates 定制被信任的证书</a></h2><p>The full code sample shows how to replace the host platform’s certificate authorities with your own set. As above, <strong>do not use custom certificates without the blessing of your server’s TLS administrator!</strong></p>
<p>完整的代码示例展示了如何用你自己的设置替换主机平台的认证中心.<strong>不要在没有通知使用你的服务器的TLS管理员的情况下定制证书!</strong></p>
<pre><code>private final OkHttpClient client;

public CustomTrust() {
  SSLContext sslContext = sslContextForTrustedCertificates(trustedCertificatesInputStream());
  client = new OkHttpClient.Builder()
      .sslSocketFactory(sslContext.getSocketFactory())
      .build();
}

public void run() throws Exception {
  Request request = new Request.Builder()
      .url(&quot;https://publicobject.com/helloworld.txt&quot;)
      .build();

  Response response = client.newCall(request).execute();
  System.out.println(response.body().string());
}

private InputStream trustedCertificatesInputStream() {
  ... // Full source omitted. See sample.
      // 详细代码请看官方sample,点击标题链接进入
}

public SSLContext sslContextForTrustedCertificates(InputStream in) {
  ... // Full source omitted. See sample.
}
</code></pre><hr>
<p><strong>对OkHttp感兴趣的朋友可以看一看Okhttp-wiki系列,可以帮助你理解Okhttp的使用方法及原理:</strong></p>
<ol>
<li><a href="http://www.jianshu.com/p/d2667e156097" target="_blank" rel="external">Okhttp-wiki 之 Home 主页</a></li>
<li><a href="http://www.jianshu.com/p/3c0b23bfcbc5" target="_blank" rel="external">Okhttp-wiki 之 Calls 调用</a></li>
<li><a href="http://www.jianshu.com/p/3d9b5de2bb1b" target="_blank" rel="external">Okhttp-wiki 之 Connections 连接</a></li>
<li><a href="http://www.jianshu.com/p/5c669861a6b1" target="_blank" rel="external">Okhttp-wiki 之 Recipes 秘诀(食谱)</a></li>
<li><a href="http://www.jianshu.com/p/2710ed1e6b48" target="_blank" rel="external">Okhttp-wiki 之 Interceptors 拦截器</a></li>
<li>Okhttp-wiki 之 HTTPS</li>
</ol>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/11/Calls/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Okhttp-wiki 之 Calls 调用
        
      </div>
    </a>
  
  
    <a href="/2016/03/11/Interceptors/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Okhttp-wiki 之 Interceptors 拦截器</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="HTTPS" data-title="Okhttp-wiki 之 HTTPS" data-url="http://yoursite.com/2016/03/11/HTTPS/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 汉之风云
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>